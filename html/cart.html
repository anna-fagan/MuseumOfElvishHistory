<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Anna Fagan">
  <link href="../css/style.css" rel="stylesheet" type="text/css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Arvo:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <title>Museum of Elvish History Cart</title>
  <style>
    /* minimal on-page styles for clarity; move to your CSS later if you want */
    main { max-width: 720px; margin: 0 auto; padding: 16px; }
    .controls { margin: 8px 0 12px; }
    .empty { padding: 12px; border: 1px dashed #666; font-style: italic; }
    pre#summary { background: #f8f8f8; padding: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .actions { margin-top: 12px; display: flex; gap: 8px; }
  </style>
</head>
<body>
  <header>
    <div class="header">
      <h1>Shopping Cart</h1>
    </div>
  </header>

  <main>
    <div class="grid-item">
      <!-- NEW CONTROLS (Cart page only) -->
      <div class="controls">
        <label><input type="checkbox" id="memberToggle"> Member Discount (15%)</label>
      </div>

      <!-- STATES & OUTPUT AREAS -->
      <div id="emptyMsg" class="empty" hidden>Your cart is empty.</div>
      <div id="items" hidden>
        <table id="shoppingCart">
          <thead>
            <tr>
              <th>Item</th>
              <th>Qty</th>
              <th>Unit Price</th>
              <th>Line Total</th>
              <th>Remove</th>
            </tr>
          </thead>
          <tbody>
            <tr id="echoDisk">
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr id="elvenBangles">
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr id="miniChalice">
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr id="moonflowerIncense">
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
      <pre id="summary" hidden></pre>

      <!-- BASIC ACTIONS -->
      <div class="actions">
        <button id="clearBtn">Clear Cart</button>
        <a href="shop.html">Keep Shopping</a>
      </div>
    </div>
  </main>

  <script>
  /* =================== PIPE FROM shop.html (leave as-is) =================== */
  // shop.html must write items with: data-id, data-name, data-price, data-image
  // addToCart(btn) should push objects { id, name, unitPrice, qty, image } to localStorage

  const CART_KEY = 'museumCartV1'; // MUST match shop.html

  function readCart(){
    try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; }
    catch { return []; }
  }
  function writeCart(cart){
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
  }
  /* ================= END PIPE ============================================= */


  /* ====================== UTILITIES & CONSTANTS =========================== */
  // Currency with parentheses for negatives
  function money(n){
    const sign = n < 0 ? -1 : 1;
    const s = '$' + Math.abs(n).toFixed(2);
    return sign < 0 ? '('+s+')' : s;
  }

  // Spec constants
  const TAX_RATE = 0.102;
  const MEMBER_DISCOUNT_RATE = 0.15;
  const SHIPPING_RATE = 25.00;
  const VOLUME_TIERS = [
    [0.00, 49.99, 0.00],
    [50.00, 99.99, 0.05],
    [100.00, 199.99, 0.10],
    [200.00, Infinity, 0.15]
  ];

  // Return the volume discount rate given an item total
  function volumeRate(total){
    for (const [min,max,rate] of VOLUME_TIERS){
      if (total >= min && total <= max) return rate;
    }
    return 0;
  }

  // Remove a line item entirely (qty=0 => drop row)
  function removeItem(id){
    const next = readCart().filter(it => it.id !== id);
    writeCart(next);
    render();
  }

  // Clear cart = initial state (cart empty, member unchecked)
  function clearCart(){
    writeCart([]);
    document.getElementById('memberToggle').checked = false;
    render();
  }
  /* ================== END UTILITIES & CONSTANTS =========================== */


  //  ====================== STUDENT WORK STARTS HERE =========================
  //    IMPLEMENT render() to mirror the commission assignment:

  //    1) Load cart from readCart(); keep only items with qty > 0 and unitPrice > 0
let cart = readCart();
  //    2) If empty → show #emptyMsg and hide #items and #summary
  // 3) Build a text-only list in #items:
  //          Example line: "2 × Celestial Inkstone               $29.90"
  //          Include a small Remove button per line that calls removeItem(id)
let itemTotal = 0;
let totalQty = 0
let shoppingCartTable = document.getElementById('shoppingCart');
if (cart.length !== 0){
  for (let i = 0; i < cart.length; i++){
    // Setting up that each item line aligns to the first aray in the object
    let itemLine= cart[i];

    // Putting the data from the line item into the table that we created
    shoppingCartTable.children[1].children[i].children[0].innerText = itemLine.name;
    shoppingCartTable.children[1].children[i].children[1].innerText = itemLine.qty;
    shoppingCartTable.children[1].children[i].children[2].innerText = money(itemLine.unitPrice);

    // Calculate line total and then put that into table
    let lineTotal = ((itemLine.qty)*(itemLine.unitPrice));
    shoppingCartTable.children[1].children[i].children[3].innerText =  money(lineTotal);

    // Create a remove button and put it into the last button spot
    let buttonCreate = document.createElement('button');
    buttonCreate.innerText = 'Remove';
    buttonCreate.addEventListener("click", removeItem(shoppingCartTable.children[1].children[i]));
    shoppingCartTable.children[1].children[i].children[4].appendChild(buttonCreate);

    // Ensure that total is being calculated
    itemTotal += lineTotal;

    // ensure total qty is being updated
    totalQty += itemLine.qty;
  }
  // Check for membership discount
  let membership = document.getElementById('memberToggle').checked;
  console.log(membership)
  // Calculate volume discount
  let volDiscount = volumeRate(itemTotal);

  // Check for volume discount vs member discount
  if (membership === true && volDiscount !== 0){
    let userChoice = prompt('You can only have one type of discount. Please enter V for Volume or M for Membership')
    
    // ensure uppercase
    userChoice = userChoice.toUpperCase();

    if (userChoice === 'M'){
      volDiscount = 0;
    } else if (userChoice === 'V'){
      isMember = false;
    } else {
      volDiscount = 0;
    }
  }

  // Set up variable otuside the if else so it can be accessed outside
  let discount;

  if (membership === true){
    discount = 0.15;
  } else if (volDiscount > 0){
    discount = volDiscount
  } else {
    discount = 0;
  }

  let appliedDiscount= (itemTotal * discount)
  let subtotal = itemTotal - appliedDiscount + SHIPPING_RATE;
  let taxAmmount = subtotal * TAX_RATE;
  let invoiceTotal = subtotal + taxAmmount;

  let summary = `Subtotal: ${money(itemTotal)}
  Volume Discount:${volDiscount*100}%
  Membership Discount:${membership*100}%
  Shipping:${money(SHIPPING_RATE)}
  Subtotal (Taxable):${money(subtotal)}
  Tax Rate:${TAX_RATE*100}%
  Tax Ammount:${money(taxAmmount)}
  Invoice Total:${money(invoiceTotal)}`;

  // Remove hidden tag from the Summary
  const outputDiv = document.getElementById('summary');
  outputDiv.removeAttribute('hidden');

  // Add text to pre tag
  outputDiv.textContent = summary;

} else{
  emptyMsg.hidden=false;
}
  // 4) Math (single-discount rule):
  //          ItemTotal = sum(unitPrice * qty)
  
  //          If Member checked AND Volume tier would apply → PROMPT user to choose:
  //            "Only one discount may be applied. Type 'M' for Member or 'V' for Volume:"
  //            Apply only the chosen one; set the other to $0.00
  //          Else apply Member OR Volume (not both)
  //          Subtotal = ItemTotal − AppliedDiscount + SHIPPING_RATE
  //          TaxAmount = Subtotal * TAX_RATE
  //          InvoiceTotal = Subtotal + TaxAmount

  //    5) Write a single summary block to #summary (like commission):
  //          Subtotal of Items
  //          Volume Discount
  //          Member Discount
  //          Shipping
  //          Subtotal (Taxable)
  //          Tax Rate %   (as a percentage text)
  //          Tax Amount $ (as currency)
  //          Invoice Total
  //    6) Recompute (call render()) after:
  //          - Member checkbox change
  //          - Clear Cart

  //          - Remove line item

  //    KEEP IT SIMPLE: text output only, one render pass.
  // ========================================================================= 

  function render(){
    const itemsDiv   = document.getElementById('items');
    const summaryPre = document.getElementById('summary');
    const emptyMsg   = document.getElementById('emptyMsg');
    const isMember   = document.getElementById('memberToggle').checked;

    // TODO: STUDENT IMPLEMENTATION
    // For now, show a placeholder so the page isn't blank.
    itemsDiv.hidden = false;
    // summaryPre.hidden = false;
    // emptyMsg.hidden = true;
    // summaryPre.textContent = 
`TODO: Implement render() per the assignment spec.

Steps:
1) Load cart from localStorage (readCart)
2) If empty → show 'Your cart is empty.'
3) Build text list of items with Remove buttons
4) Compute totals with exactly one discount (prompt if both apply)
5) Output a single summary block (commission-style)`;
  } 

  // Events → re-render
  document.getElementById('memberToggle').addEventListener('change', render);
  document.getElementById('clearBtn').addEventListener('click', clearCart);

  // First paint
  render();

  

  </script>
</body>
</html>
